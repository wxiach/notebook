# 如何优雅的终止线程

怎么在T1线程中优雅地终止T2线程，所谓优雅是指T2线程在真正终止以前，可以继续执行一些代码做收尾工作。

> 因为`stop()` 方法是强制终止一个线程，会导致线程终止的时候资源不能正确释放，产生死锁问题，不建议使用。

下面是一段常用的线程终止方式：

```java
public class Main {
    public static void main(String[] args) throws InterruptedException {
        CustomThread customThread = new CustomThread();
        customThread.start();
        TimeUnit.SECONDS.sleep(3);
        customThread.stop();
    }
}

class CustomThread {
    private Thread t;

    public void start() {
        t = new Thread(() -> {
            while (true) {
                Thread currentThread = Thread.currentThread();
                if (currentThread.isInterrupted()) {
                    System.out.println("execute the rest work");
                    break;
                }
                try {
                    Thread.sleep(1000);
                    System.out.println("execute the main work");
                } catch (InterruptedException e) {
                    // 必须加上这行行代码，线程才能正常终止
                    currentThread.interrupt();
                }
            }
        });
        t.start();
    }

    public void stop() {
        t.interrupt();
    }
}
```

先理解interrupt终止线程的原理。`interrupt()`会将Thread中的`interrupted`变量设置为true，也就是我们常说的设置终止标志。通过检测这个终止标志的值来决定是否结束当前run方法的运行。run方法一旦运行结束，就会让线程进入TERMINATED状态。

那为什么我们上面需要双重interrupt呢？因为TIMED_WAITING状态中的线程，如果被interrupt会抛出`InterruptedException`异常，同时清除终止标志，所以我们需要第二次调用interrupt来重新设置终止标志。
