# Java 内存模型

JMM（Java Memory Model, Java 内存模型）是一个抽象的概念，并不是真实的物理内存结构。它定义了 Java 程序中线程如何访问共享变量的规则和约束。

- 保证了多线程编程中的**可见性、原子性和有序性**。
- 屏蔽了各个硬件平台和操作系统的内存访问差异。

## 主内存与工作内存

**主内存**是所有线程共享的内存区域，线程创建的对象都存储在主内存中（无论是成员变量还是局部变量），类信息、常量、静态变量等也存储在主内存中。

**工作内存**是每个线程独立的内存区域，工作内存中存储了主内存中变量的副本。线程对变量的操作都是在工作内存中进行的，只有在需要与其他线程共享数据时，才会将数据从工作内存同步到主内存。

![主内存与工作内存](/public/images/主内存与工作内存.png)

## happens-before 规则

指令重排是编译器和 CPU 为提高程序执行效率而调整指令顺序的过程，包括「编译器重排」和「处理器重排」。

**指令重排可以保证串行语义一致，但不能保证多线程间的语义也一致。** 可以通过禁止指令重排或者使用内存屏障来确保多线程间的语义一致。

> 内存屏障（Memory Barrier/Fence）是 CPU 指令，用于禁止指令重排序，保证执行有序性。它还通过强制刷新写缓冲、使本地缓存失效来确保变量的可见性。

JVM 设计了 happens-before 规则用来约束指令重排序，它保证了**前一个操作的结果对后一个操作可见**。
